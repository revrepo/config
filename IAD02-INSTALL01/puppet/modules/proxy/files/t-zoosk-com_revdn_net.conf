#
# This file is managed by Rev Puppet service as described on Wiki
# page https://revwiki.atlassian.net/wiki/display/OP/Puppet+Centralized+Configuration+Management+System
# Please don't modify the file on the Puppet client server since your changes will be overwritten on the next
# Puppet agent run on the server.
#

<VirtualHost *:80>
    ServerName t-zoosk-com.revdn.net



    # If we've already visited this server during this request, in the same role (BP or CO),
    # return an error page and status 508 (loop detected).
    RewriteEngine On
    RewriteCond %{HTTP:X-Rev-Nodes} YYZ02-BP01
    RewriteRule ^(.*)$ - [R=508,L]
    ErrorDocument 508 "A redirection loop was detected on 'YYZ02-BP01'. Please review the server configuration."
    # Add this host to the request list of visited nodes
    RequestHeader append X-Rev-Nodes YYZ02-BP01


    # mod_status (debug)
    <Location /rev-status>
        SetHandler server-status
        Require local
    </Location>
    # Don't pass /rev-status through proxy
    ProxyPass /rev-status !

    # Never disable the Varnish backend, even if it has temporary problems.
    ProxyPass / http://127.0.0.1:8080/ retry=0
    ProxyPassReverse / http://127.0.0.1:8080/
    ProxyPreserveHost On

    # mod_rev_profile_selection
    RevProfilesMode varnish_step1

    # Start rules from scratch
    RevProfilesFlushSelectionRules

    # Run customized profile selection algo
    # Always use profile 0 by default
    RevProfilesAddSelectionRule 0 1==1

    # Security setup
    SecRuleEngine Off
    SecAuditLogStorageDir /var/cache/modsecurity/audit/t-zoosk-com.revdn.net/
    SecAuditLog "/var/cache/modsecurity/audit/t-zoosk-com.revdn.net.index"
    SecAuditLogType Concurrent

</VirtualHost>

<VirtualHost 127.0.0.1:9080>
    # Don't log accesses on this vhost; they all come from localhost
    CustomLog /dev/null revsw

    # Make sure the connections between Varnish and BP are kept alive for 10 minutes
    KeepAliveTimeout 600

    # Don't add X-Forwarded-For in this step, it's already added in step1
    ProxyAddHeaders Off
    # Don't count traffic twice
    RevTrafficCounterEnabled Off


    # Optional customizations before generic BP config

    # End optional customizations before generic BP config


    # HTTP static content servers



    # Transitional config for upgrade from 09/12
    # HTTP static content servers

    # HTTPS static content servers

    # End Transitional

    ServerName t-zoosk-com.revdn.net



    # mod_status (debug)
    <Location /rev-status>
        SetHandler server-status
        Require local
    </Location>
    # Don't pass /rev-status through proxy
    ProxyPass /rev-status !


    <Location /rev-diablo>
        ProxyPreserveHost Off
        RevProfilesMode Off
        ProxyPass http://72.172.186.67
        ProxyPassReverse http://72.172.186.67
    </Location>


    # mod_proxy and mod_proxy_balancer
    # Balancer members are reused immediately even if they have errors (retry=0),
    # to allow for DNS-based HA.
    # We try to maintain a connection to them for as long as possible (keepalive=On).
    Header add Set-Cookie "ROUTEID=.%{BALANCER_WORKER_ROUTE}e; path=/" env=BALANCER_ROUTE_CHANGED
    <Proxy balancer://bp_cos>
        BalancerMember http://sea02-co01-vip01.revdn.net route=1 keepalive=On retry=0
        ProxySet stickysession=ROUTEID
    </Proxy>
    ProxyPass / balancer://bp_cos/
    ProxyPassReverse / balancer://bp_cos/
    ProxyPassReverse / http://t-zoosk-com.revdn.net/
    ProxyPreserveHost On

    # Wait at most 5 seconds for a reply from CO, then return error message.
    # This will make recovery from CO failure quicker.
    # The DNS monitor will assign another CO to the same domain name.
    ProxyTimeout 5

    # mod_rev_profile_selection
    ProxyConnPoolCount 1
    RevProfilesBasePort 18000

    RevProfilesMode varnish_step2


    # Optional customizations after generic BP config

#
    # End optional customizations after generic BP config
</VirtualHost>

<VirtualHost *:443>
    # Begin SSL setup (no proxy)
    SSLEngine On
    # Disable SSLv2/3 because of SNI, which requires TLS
    SSLProtocol All -SSLv2 -SSLv3
    # Mitigate CRIME attack
    SSLCompression off
    # Use stronger ciphers, which may mitigate BEAST attacks
    SSLHonorCipherOrder on
    SSLCipherSuite "EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA 3DES RC4 !aNULL !eNULL !LOW !MD5 !EXP !PSK !SRP !DSS +3DES 3DES +RC4 RC4"
    SSLCACertificateFile /opt/revsw-config/apache/generic-site/certs/ca-bundle.crt
    SSLCertificateFile /opt/revsw-config/apache/generic-site/certs/server.crt
    SSLCertificateKeyFile /opt/revsw-config/apache/generic-site/certs/server.key
    # End SSL setup

    # OCSP stapling is only enabled on the BP
    SSLUseStapling on
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors off

    # mod_spdy
    SpdyEnabled On

    ServerName t-zoosk-com.revdn.net



    # If we've already visited this server during this request, in the same role (BP or CO),
    # return an error page and status 508 (loop detected).
    RewriteEngine On
    RewriteCond %{HTTP:X-Rev-Nodes} YYZ02-BP01
    RewriteRule ^(.*)$ - [R=508,L]
    ErrorDocument 508 "A redirection loop was detected on 'YYZ02-BP01'. Please review the server configuration."
    # Add this host to the request list of visited nodes
    RequestHeader append X-Rev-Nodes YYZ02-BP01


    # mod_status (debug)
    <Location /rev-status>
        SetHandler server-status
        Require local
    </Location>
    # Don't pass /rev-status through proxy
    ProxyPass /rev-status !

    # Begin SSL setup (proxy-only) for bypassing varnish and
    # apache back-end (9443)
    SSLProxyEngine On
    # Disable SSLv2/3 because of SNI, which requires TLS
    SSLProxyProtocol All -SSLv2 -SSLv3
    SSLProxyCheckPeerName Off
    SSLProxyCheckPeerCN Off
    # End SSL setup
    # Wait at most 5 seconds for a reply from CO, then return error message.
    ProxyTimeout 5
    # mod_rev_profile_selection
    ProxyConnPoolCount 1
    RevProfilesBasePort 19000
    <Location /login>
        ProxyPass https://sea02-co01-vip01.revdn.net/login
        ProxyPassReverse https://sea02-co01-vip01.revdn.net/login
        ProxyPreserveHost On
        RevProfilesMode full
    </Location>
    ProxyPass /login !

    # Never disable the Varnish backend, even if it has temporary problems.
    ProxyPass / http://127.0.0.1:8443/ retry=0
    ProxyPassReverse / http://127.0.0.1:8443/
    ProxyPreserveHost On

    # mod_rev_profile_selection
    RevProfilesMode varnish_step1

    # Start rules from scratch
    RevProfilesFlushSelectionRules

    # Run customized profile selection algo
    # Always use profile 0 by default
    RevProfilesAddSelectionRule 0 1==1

    # Security setup
    SecRuleEngine Off
    SecAuditLogStorageDir /var/cache/modsecurity/audit/t-zoosk-com.revdn.net/
    SecAuditLog "/var/cache/modsecurity/audit/t-zoosk-com.revdn.net.index"
    SecAuditLogType Concurrent

</VirtualHost>

<VirtualHost 127.0.0.1:9443>
    # Begin SSL setup (proxy-only)
    SSLProxyEngine On
    # Disable SSLv2/3 because of SNI, which requires TLS
    SSLProxyProtocol All -SSLv2 -SSLv3
    SSLProxyCheckPeerName Off
    SSLProxyCheckPeerCN Off
    # End SSL setup

    # Don't log accesses on this vhost; they all come from localhost
    CustomLog /dev/null revsw

    # Make sure the connections between Varnish and BP are kept alive for 10 minutes
    KeepAliveTimeout 600

    # Don't add X-Forwarded-For in this step, it's already added in step1
    ProxyAddHeaders Off
    # Don't count traffic twice
    RevTrafficCounterEnabled Off
    # Optional customizations before generic BP config

    # End optional customizations before generic BP config


    # HTTP static content servers


    # HTTPS static content servers


    # Transitional config for upgrade from 09/12
    # HTTP static content servers

    # HTTPS static content servers

    # End Transitional

    ServerName t-zoosk-com.revdn.net



    # mod_status (debug)
    <Location /rev-status>
        SetHandler server-status
        Require local
    </Location>
    # Don't pass /rev-status through proxy
    ProxyPass /rev-status !


    <Location /rev-diablo>
        ProxyPreserveHost Off
        RevProfilesMode Off
        ProxyPass http://72.172.186.67
        ProxyPassReverse http://72.172.186.67
    </Location>


    # mod_proxy and mod_proxy_balancer
    # Balancer members are reused immediately even if they have errors (retry=0),
    # to allow for DNS-based HA.
    # We try to maintain a connection to them for as long as possible (keepalive=On).
    Header add Set-Cookie "ROUTEID=.%{BALANCER_WORKER_ROUTE}e; path=/" env=BALANCER_ROUTE_CHANGED
    <Proxy balancer://bp_cos>
        BalancerMember https://sea02-co01-vip01.revdn.net route=1 keepalive=On retry=0
        ProxySet stickysession=ROUTEID
    </Proxy>
    ProxyPass / balancer://bp_cos/
    ProxyPassReverse / balancer://bp_cos/
    ProxyPassReverse / http://t-zoosk-com.revdn.net/
    ProxyPreserveHost On

    # Wait at most 5 seconds for a reply from CO, then return error message.
    # This will make recovery from CO failure quicker.
    # The DNS monitor will assign another CO to the same domain name.
    ProxyTimeout 5

    # mod_rev_profile_selection
    ProxyConnPoolCount 1
    RevProfilesBasePort 19000

    RevProfilesMode varnish_step2


    # mod_pagespeed in CO looks at this header when optimizing for SPDY
    Header add X-PSA-Optimize-For-SPDY On

    # Optional customizations after generic BP config

#
    # End optional customizations after generic BP config
</VirtualHost>
